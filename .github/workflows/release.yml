name: Bundle Pebble Windows EXEs (flat) and Create Release

on:
  workflow_dispatch:
    inputs:
      pebble_version:
        description: "Pebble version tag (e.g. v2.9.0)"
        required: true
        default: "v2.9.0"

permissions:
  contents: write

jobs:
  bundle-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare variables
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          VER="${{ inputs.pebble_version }}"
          echo "version=$VER" >> "$GITHUB_OUTPUT"
          echo "workdir=pebble_artifacts" >> "$GITHUB_OUTPUT"
          echo "outzip=pebble-exes-${VER}.zip" >> "$GITHUB_OUTPUT"

      - name: Create working directory
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ steps.vars.outputs.workdir }}"

      - name: Download Pebble release zips
        shell: bash
        run: |
          set -euo pipefail
          VER="${{ steps.vars.outputs.version }}"
          cd "${{ steps.vars.outputs.workdir }}"

          URL1="https://github.com/letsencrypt/pebble/releases/download/${VER}/pebble-windows-amd64.zip"
          URL2="https://github.com/letsencrypt/pebble/releases/download/${VER}/pebble-challtestsrv-windows-amd64.zip"

          curl -fL --retry 3 --retry-delay 2 -o pebble-windows-amd64.zip "$URL1"
          curl -fL --retry 3 --retry-delay 2 -o pebble-challtestsrv-windows-amd64.zip "$URL2"

      - name: Unzip both archives into the same folder
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.vars.outputs.workdir }}"
          unzip -o pebble-windows-amd64.zip
          unzip -o pebble-challtestsrv-windows-amd64.zip

      - name: Flatten all .exe into one folder (no subdirs)
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.vars.outputs.workdir }}"

          mkdir -p flat

          # Находим exe рекурсивно
          mapfile -d '' EXES < <(find . -type f -iname '*.exe' -print0)

          if [ "${#EXES[@]}" -eq 0 ]; then
            echo "No .exe files found after unzip."
            exit 1
          fi

          echo "Found ${#EXES[@]} exe files:"
          printf ' - %s\n' "${EXES[@]}"

          for f in "${EXES[@]}"; do
            base="$(basename "$f")"

            # если имя уже занято — добавим "хвост" из пути
            if [ -e "flat/$base" ]; then
              # путь -> безопасное имя: ./a/b/c.exe => a-b-c.exe
              safe="$(echo "$f" | sed -E 's|^\./||; s|/|-|g')"
              safe="${safe%.*}.exe"
              cp -f "$f" "flat/$safe"
              echo "Name conflict: $base -> $safe"
            else
              cp -f "$f" "flat/$base"
            fi
          done

      - name: Create zip with EXEs in root
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.vars.outputs.workdir }}/flat"
          zip -9 "../${{ steps.vars.outputs.outzip }}" *.exe
          mv "../${{ steps.vars.outputs.outzip }}" "../../${{ steps.vars.outputs.outzip }}"

      - name: Create GitHub Release and upload zip
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.version }}
          name: Pebble Windows EXEs bundle (${{ steps.vars.outputs.version }})
          body: |
            ZIP содержит все `.exe` в корне (без подпапок).
            Источники:
            - pebble-windows-amd64.zip
            - pebble-challtestsrv-windows-amd64.zip
          files: |
            ${{ steps.vars.outputs.outzip }}
